<!--
Copyright 2013 The Toolkitchen Authors. All rights reserved.
Use of this source code is governed by a BSD-style
license that can be found in the LICENSE file.
-->
<script src="reflection.js"></script>

<element name="tk-inspector" attributes="element">
  <template>
    <style>
      @host {
        * {
          border: 1px solid silver;
        }
      }
      #header {
        background-color: #E0E0E0;
        border-bottom: 1px solid silver;
        padding-top: 4px;
        height: 44px;
        /*line-height: 60px;*/
      }
      #interior {
        position: absolute;
        top: 62px;
        right: 0;
        bottom: 0;
        left: 0;
        padding: 8px;
        overflow-x: hidden;
        overflow-y: auto;
      }
      g-icon-button {
        vertical-align: middle;
      }
    </style>
    <div id="header">
      <g-icon-button src="assets/ic_chevron_left_darkreg.png" on-click="selectParentElement"></g-icon-button>
      <b>{{name}}</b>
      <g-icon-button src="assets/ic_delete_darkreg.png" on-click="deleteElement" style="float: right"></g-icon-button>
    </div>
    <div id="interior">
      <template repeat="{{properties}}">
        <tk-property-editor property="{{}}"></tk-property-editor>
      </template>
      <tk-style-inspector element="{{element}}"></tk-style-inspector>
    </div>
  </template>
  <script>
    Toolkit.register(this, {
      element: null,
      properties: null,
      name: '',
      elementChanged: function() {
        this.properties = Reflection.properties(this.element);
        this.name = this.element && this.element.localName || '';
      },
      deleteElement: function() {
        this.send('delete-element');
      },
      selectParentElement: function() {
        this.send('parent-element');
      }
    });
  </script>
</element>

<element name="tk-style-inspector" attributes="element">
  <template>
    <template repeat="{{properties}}">
      <tk-property-editor property="{{}}"></tk-property-editor>
    </template>
    <tk-meta id="meta">
      <property name="backgroundColor" kind="color"></property>
      <property name="opacity" kind="range" min="0" max="1" step="0.1" defaultvalue="1"></property>
      <property name="border"></property>
      <property name="width"></property>
      <property name="height"></property>
      <property name="test" kind="tk-compound-editor"></property>
    </tk-meta>
  </template>
  <script>
    Toolkit.register(this, {
      properties: null,
      elementChanged: function() {
        this.properties = Reflection.styles(this.element, this.$.meta.properties);
      }
    });
  </script>
</element>

<element name="tk-property-editor" attributes="property">
  <template>
    <style>
      @host {
        *{
          display: block;
          white-space: nowrap;
          margin-bottom: 12px;
        }
      }
      .property-name {
        text-overflow: ellipsis;
        overflow: hidden;
        color: #949494;
        font-size: 0.9rem;
        font-weight: bold;
        margin-bottom: 8px;
      }
      #container {
        display: inline-block;
        width: 92%;
      }
      #icon {
        opacity: 0.3;
        vertical-align: middle;
      }
      #icon.bound {
        opacity: 1;
      }
    </style>
    <div class="property-name">{{property.name}}:</div>
    <div id="container"><content></content><tk-string-editor id="binder"></tk-string-editor></div><g-icon id="icon" src="assets/link_dark.png" size="16" on-click="linkTap"></g-icon>
    <g-flip id="flip" targetSelector="#container" on-complete="flipComplete"></g-flip>
  </template>
  <script>
    Toolkit.register(this, {
      property: null,
      editor: null,
      active: null,
      bound: null,
      editorTypes: {
        'boolean': 'tk-boolean-editor',
        'string': 'tk-string-editor',
        'select': 'tk-select-editor',
        'color': 'tk-color-editor',
        'text': 'tk-text-editor',
        'id-select': 'tk-id-select-editor',
        'target-select': 'tk-target-select-editor',
        'speech': 'tk-speech-editor',
        'range': 'tk-range-editor',
        any: 'tk-string-editor'
      },
      ready: function() {
        this.bound = false;
      },
      propertyChanged: function() {
        var m = this.property.meta;
        var type = this.editorTypes[m && m.kind || typeof this.property.value] || (m && m.kind);
        this.editor = document.createElement(type || this.editorTypes.any);
        this.editor.property = this.property;
        //
        var bindingProperty = document.createElement('tk-binding-property');
        bindingProperty.property = this.property;
        this.$.binder.property = bindingProperty;
        // really hide the binder
        this.$.binder.style.display = 'none';
        this.active = this.editor;
      },
      editorChanged: function(inOld) {
        if (inOld) {
          inOld.parentNode.removeChild(inOld);
        }
        this.appendChild(this.editor);
        //this.$.flip.target = this.editor;
        //this.$.flip.targetSelector = ".property-name";
      },
      linkTap: function() {
        this.$.flip.play();
      },
      flipComplete: function() {
        this.bound = !this.bound;
      },
      boundChanged: function() {
        this.active = this.bound ? this.$.binder : this.editor;
        this.$.icon.classList.toggle('bound', this.bound);
      },
      activeChanged: function(oldValue) {
        if (oldValue) {
          oldValue.style.display = 'none';
        }
        this.active.style.display = null;
        this.active.focus();
      }
    });
  </script>
</element>

<!-- manager for binding properties -->
<element name="tk-binding-property" attributes="property value">
  <script>
    Toolkit.register(this, {
      name: 'value',
      value: null,
      obj: null,
      meta: null,
      model: null,
      ready: function() {
        this.obj = this;
      },
      propertyChanged: function() {
        this.meta = this.property.meta;
        this.value = calcBoundValue(this.property.obj, this.property.name);
      },
      valueChanged: function(oldValue) {
        if (oldValue === null) {
          return;
        }
        if (isBound(oldValue)) {
          removeBinding(this.property.obj, this.property.name);
        }
        if (isBound(this.value)) {
          makeBinding(this.property.obj, this.property.name, this.value);
        }
      }
    });
    
    // TODO(sorvell): promote to toolkit and integrate with Element.unbind
    Toolkit.unbindProperty = function(inA, inProperty) {
      Object.defineProperty(inA, inProperty, {
        value: inA[inProperty],
        enumerable: true,
        writable: true,
        configurable: true
      });
    }
    function isBound(value) {
      return value.match(Toolkit.bindPattern);
    }
    function calcBoundValue(obj, name) {
      value = '';
      if (obj.__bindings && obj.__bindings[name]) {
        value = obj.__bindings[name];
      } else if (obj.hasAttribute && obj.hasAttribute(name)) {
        var attr = obj.getAttribute(name);
        if (isBound(attr)) {
          value = attr;
        }
      }
      return value;
    }
    // NOTE: store binding info on the object so we can tell
    // if the object has a binding.
    function makeBinding(obj, name, value) {
      obj.__bindings = obj.__bindings || {};
      obj.__bindings[name] = value;
      obj.setAttribute(name, value);
      // for textContent
      obj[name] = value;
      //obj.bind(name, model, value);
      // TODO(sorvell): apply binding here? need access to model to do so...
    }
    function removeBinding(obj, name) {
      obj.__bindings = obj.__bindings || {};
      obj.__bindings[name] = null;
      obj.removeAttribute(name);
      // TODO(sorvell): shouldn't unbind here and bind elsewhere!
      obj.unbind(name);
      // TODO(sorvell): remove when toolkit supports unbind for special bindings
      Toolkit.unbindProperty(obj, name);
      // set value ex post facto to handle inability set textContent
      // when unbinding
      obj[name] = obj[name];
    }
  </script>
</element>