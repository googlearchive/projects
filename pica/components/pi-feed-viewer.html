<!--
/*
 * Copyright 2012 The Toolkitchen Authors. All rights reserved.
 * Use of this source code is governed by a BSD-style
 * license that can be found in the LICENSE file.
 */
-->
<element name="pi-feed-viewer" attributes="panel layout">
  <link rel="stylesheet" href="css/pi-feed-viewer.css" />
  <link rel="components" href="../../../toolkit/components/g-panels.html"/>
  <link rel="components" href="pi-gfeeds.html"/>
  <link rel="components" href="pi-feed-aggregator.html"/>
  <link rel="components" href="pi-items-view.html"/>
  <link rel="components" href="pi-story.html"/>
  <template>
    <g-panels id="panels" autoselect selected="{{panel}}" transition="keyframe" on-select="panelSelected" on-canselect="panelCanSelect">
      <pi-items-view id="topics" layout="{{layout}}" items="{{topics}}" view="topics" selected="{{selectedTopic}}"></pi-items-view>
      <pi-items-view id="stories" layout="{{layout}}" items="{{stories}}" selected="{{selectedStory}}"></pi-items-view>
      <pi-story id="story" story="{{selectedStory}}" on-keydown="keydownHandler"></pi-story>
    </g-panels>
    <div id="loading" loading="{{loading}}">Loading...</div>
    <pi-feed-aggregator id="gfeeds" feed="{{selectedTopic.feed}}" count="200" entries="{{stories}}" loading="{{loading}}"></pi-feed-aggregator>
  </template>
  <script>
    var RIGHT_ARROW_KEY = 39;
    var LEFT_ARROW_KEY = 37;
    
    // TODO(sorvell): if necessary, shouldn't go here
    var isEmpty = function(inObj) {
      if (inObj) {
        for (var i in inObj) {
          return false;
        }
      }
      return true;
    }
    
    this.component({
      publish: {
        topics: null,
        selectedTopic: null,
        previous: function() {
          this.$.panels.previous();
        }
      },
      ready: function() {
        var mq = window.matchMedia('(max-width: 800px)');
        mq.addListener(this.layoutChange.bind(this));
        this.layoutChange(mq);
      },
      layoutChange: function(inQuery) {
        this.$.panels.className = inQuery.matches ? 'g-panels-fly-up-right' : 
          'g-panels-scale-slide';
      },
      topicsChanged: function() {
        this.topics.forEach(function(t) {
          var fa = document.createElement('pi-feed-aggregator');
          fa.count = 4;
          fa.addEventListener('response', function(e) {
            var ns = e.detail && e.detail.entries || [];
            for (var i = 0, n; n = ns[i]; i++) {
              if (n.imgSrc) {
                t.imgSrc = n.imgSrc;
                return;
              }
            }
          });
          fa.feed = t.feed;
        });
      },
      storiesChanged: function() {
        if (this.stories) {
          this.panel = 'stories';
        }
      },
      selectedStoryChanged: function() {
        if (!isEmpty(this.selectedStory)) {
          this.panel = 'story';
        }
      },
      nextPrevStory: function(inPrev) {
        var i = this.stories.indexOf(this.selectedStory);
        var s = this.stories[i + (inPrev ? -1 : 1)];
        if (s) {
          this.selectedStory = s;
          return true;
        }
      },
      // TODO(sorvell): handle selected event since this fires after the selection
      // is complete and this is when we want to make the following changes.
      // note, we want selectedTopic/Story to become unset
      // when the panel that shows them is not selected, this allows
      // us to rely on selectedTopic/StoryChanged to show the relevant
      // panel.
      // it's important to set selectedTopic to {} so that
      // selectedTopic.feed actually changes and updates gfeeds.feed.
      panelSelected: function(e, inDetail, inSender) {
        if (inSender.selected == 'topics') {
          this.selectedTopic = {};
        } else if (inSender.selected == 'stories') {
          this.selectedStory = {};
        }
        //
        if (inSender.selected == 'story') {
          this.$.story.focus();
        } else {
          inSender.focus();
        }
      },
      panelCanSelect: function(e, inDetail) {
        if ((inDetail.selected == 'stories' && (!this.stories && !this.$.gfeeds.loading)) || 
           (inDetail.selected == 'story' && isEmpty(this.selectedStory))) {
          inDetail.preventSelect();
        }
      },
      keydownHandler: function(e) {
        var p = false;
        if (e.keyCode == RIGHT_ARROW_KEY) {
          p = this.nextPrevStory();
        } else if (e.keyCode == LEFT_ARROW_KEY) {
          p = this.nextPrevStory(true);
        }
        if (p) {
          e.cancelBubble = true;
        }
      }
    });
  </script>
</element>
